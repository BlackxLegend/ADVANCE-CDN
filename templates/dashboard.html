<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CDN Dashboard</title>
  <style>
    body{margin:0;background:#020b14;color:#00ffcc;font-family:monospace}
    .top{padding:14px 18px;border-bottom:1px solid #00ffcc33;display:flex;justify-content:space-between;align-items:center}
    .wrap{display:grid;grid-template-columns:320px 1fr 420px;gap:14px;padding:14px}
    .card{border:1px solid #00ffcc;padding:14px;background:#01060c;box-shadow:0 0 22px #00ffcc22;border-radius:10px}
    h3{margin:0 0 10px 0;color:#00ffaa}
    .row{display:flex;justify-content:space-between;margin:6px 0}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #00ffcc22;padding:6px;text-align:left}
    .btn{display:inline-block;padding:8px 10px;border:1px solid #00ffcc;background:#020b14;color:#00ffcc;text-decoration:none;border-radius:8px}
    .btn:hover{background:#00ffcc;color:#020b14}
    input[type="file"]{width:100%}
    small{color:#00ffccaa}
  </style>
</head>
<body>
  <div class="top">
    <div>⚡ KALI REAL-TIME SECURITY ADMIN PANEL ⚡</div>
    <div>
      <a class="btn" href="/logout">Logout</a>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h3>System</h3>
      <div class="row"><span>CPU</span><span id="cpu">-</span></div>
      <div class="row"><span>RAM</span><span id="ram">-</span></div>
      <div class="row"><span>RPS</span><span id="rps">-</span></div>
      <div class="row"><span>Connections</span><span id="conns">-</span></div>
      <div class="row"><span>iptables DROPs</span><span id="drops">0</span></div>
      <div class="row"><span>SSH fails</span><span id="ssh">0</span></div>
      <hr style="border:0;border-top:1px solid #00ffcc22;margin:10px 0">
      <div class="row"><span>Upload speed</span><span id="us">0 Mbps</span></div>
      <div class="row"><span>Download speed</span><span id="ds">0 Mbps</span></div>
      <div class="row"><span>Bandwidth total</span><span id="bw">0 GB</span></div>
      <div class="row"><span>Disk used</span><span id="disk">-</span></div>
      <div class="row"><span>Media folder</span><span id="media_mb">-</span></div>
      <div class="row"><span>Total images / videos</span><span id="counts">-</span></div>
      <hr style="border:0;border-top:1px solid #00ffcc22;margin:10px 0">
      <div class="row"><span>Top viewed file</span><span id="top">-</span></div>
    </div>

    <div class="card">
      <h3>Expiring files</h3>
      <table>
        <thead>
          <tr>
            <th>File</th><th>Tier</th><th>Size</th><th>Uploaded</th><th>Delete</th><th>Left</th>
          </tr>
        </thead>
        <tbody id="files"></tbody>
      </table>
      <small>Auto-deletes based on tier TTL.</small>
    </div>

    <div class="card">
      <h3>Media Upload</h3>
      <div class="row"><span>Base</span><span id="base">-</span></div>
      <form id="upform">
        <input type="file" name="file" required>
        <label style="display:block;margin-top:10px">
          <input type="checkbox" name="allow_big" value="1">
          Allow 100–200MB video (auto-delete 42h)
        </label>
        <button class="btn" style="margin-top:10px" type="submit">Upload</button>
      </form>
      <div id="upmsg" style="margin-top:10px;min-height:18px;color:#00ffaa"></div>
      <hr style="border:0;border-top:1px solid #00ffcc22;margin:10px 0">
      <small>Uploaded files become public at <b>/media/&lt;filename&gt;</b></small>
    </div>
  </div>

<script>
async function refreshStats(){
  const r = await fetch("/api/stats");
  if(!r.ok) return;
  const s = await r.json();

  document.getElementById("cpu").textContent = s.cpu.toFixed(1) + "%";
  document.getElementById("ram").textContent = s.ram.toFixed(1) + "%";
  document.getElementById("rps").textContent = s.rps;
  document.getElementById("conns").textContent = s.connections;
  document.getElementById("drops").textContent = s.iptables_drops;
  document.getElementById("ssh").textContent = s.ssh_fails;

  document.getElementById("us").textContent = (s.upload_speed_mbps || 0) + " Mbps";
  document.getElementById("ds").textContent = (s.download_speed_mbps || 0) + " Mbps";
  document.getElementById("bw").textContent = (s.bandwidth_total_gb || 0) + " GB";

  const du = (s.disk_used_gb ?? 0);
  const dt = (s.disk_total_gb ?? 0);
  document.getElementById("disk").textContent = du + "/" + dt + " GB";
  document.getElementById("media_mb").textContent = (s.media_folder_mb ?? 0) + " MB";
  document.getElementById("counts").textContent = (s.total_images ?? 0) + " / " + (s.total_videos ?? 0);

  document.getElementById("top").textContent = s.top_viewed_file ? (s.top_viewed_file + " (" + s.top_viewed_count + ")") : "-";
  document.getElementById("base").textContent = s.media_base;
}

async function refreshFiles(){
  const r = await fetch("/api/files");
  if(!r.ok) return;
  const files = await r.json();
  const tb = document.getElementById("files");
  tb.innerHTML = "";
  for(const f of files){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><a href="${f.url}" target="_blank" style="color:#00ffcc">${f.original}</a></td>
      <td>${f.tier}</td>
      <td>${f.size_mb} MB</td>
      <td>${new Date(f.uploaded_at).toLocaleString()}</td>
      <td>${new Date(f.delete_at).toLocaleString()}</td>
      <td>${f.left_h}h</td>
    `;
    tb.appendChild(tr);
  }
}

document.getElementById("upform").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);

  // allow_big checkbox -> send allow_big=1 when checked
  const allow = form.querySelector('input[name="allow_big"]').checked;
  if(allow) fd.set("allow_big", "1");

  const r = await fetch("/media", { method:"POST", body: fd });
  const out = await r.json().catch(()=>({ok:false,error:"Upload failed"}));

  const msg = document.getElementById("upmsg");
  if(out.ok){
    msg.textContent = `Uploaded: ${out.stored} | Tier ${out.tier} | URL: ${out.url}`;
    form.reset();
    refreshFiles();
    refreshStats();
  } else {
    msg.textContent = out.error || "Upload error";
  }
});

refreshStats();
refreshFiles();
setInterval(refreshStats, 2000);
setInterval(refreshFiles, 5000);
</script>
</body>
</html>
